name: iOS E2E Tests

# Run E2E tests on demand or before releases
# These are slower and test full user flows via XCUITest
on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter (e.g., AccountDeletionUITests or leave empty for all)'
        required: false
        default: ''
  # Optionally run on release branches
  push:
    branches:
      - 'release/*'

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: self-hosted

    env:
      DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      # Test credentials (from GitHub Secrets)
      TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL }}
      TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD }}
      TEST_SUPABASE_URL: ${{ secrets.TEST_SUPABASE_URL }}
      TEST_SUPABASE_ANON_KEY: ${{ secrets.TEST_SUPABASE_ANON_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          xcodebuild -version
          xcrun simctl list devices available | head -20

      - name: Setup API Config for E2E Tests
        run: |
          # Use test Supabase credentials for E2E tests
          cp Food1/Config/APIConfig.swift.template Food1/Config/APIConfig.swift

          # Configure with test Supabase (if secrets are available)
          if [ -n "$TEST_SUPABASE_URL" ]; then
            /usr/libexec/PlistBuddy -c "Add :SUPABASE_URL string '$TEST_SUPABASE_URL'" Food1/Info.plist || \
            /usr/libexec/PlistBuddy -c "Set :SUPABASE_URL '$TEST_SUPABASE_URL'" Food1/Info.plist
            /usr/libexec/PlistBuddy -c "Add :SUPABASE_ANON_KEY string '$TEST_SUPABASE_ANON_KEY'" Food1/Info.plist || \
            /usr/libexec/PlistBuddy -c "Set :SUPABASE_ANON_KEY '$TEST_SUPABASE_ANON_KEY'" Food1/Info.plist
            echo "‚úÖ Configured with test Supabase credentials"
          else
            # Fallback to dummy values
            /usr/libexec/PlistBuddy -c "Add :SUPABASE_URL string 'https://test.supabase.co'" Food1/Info.plist || true
            /usr/libexec/PlistBuddy -c "Add :SUPABASE_ANON_KEY string 'test-anon-key'" Food1/Info.plist || true
            echo "‚ö†Ô∏è  Using dummy Supabase credentials (no TEST_SUPABASE_* secrets configured)"
          fi

          # Add other required config
          /usr/libexec/PlistBuddy -c "Add :PROXY_ENDPOINT string 'https://test-worker.example.com/analyze'" Food1/Info.plist || true
          /usr/libexec/PlistBuddy -c "Add :AUTH_TOKEN string 'test-auth-token'" Food1/Info.plist || true

      - name: Boot Simulator
        run: |
          # Boot iPhone 17 Pro simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 17 Pro" | head -1 | grep -oE '[A-F0-9-]{36}')
          if [ -n "$SIMULATOR_ID" ]; then
            xcrun simctl boot "$SIMULATOR_ID" || true
            echo "‚úÖ Booted simulator: $SIMULATOR_ID"
          else
            echo "‚ö†Ô∏è  iPhone 17 Pro simulator not found, using default"
          fi

      - name: Build for UI Testing
        run: |
          xcodebuild clean build-for-testing \
            -project Food1.xcodeproj \
            -scheme Food1 \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run E2E Tests
        run: |
          TEST_FILTER="${{ github.event.inputs.test_filter }}"

          if [ -n "$TEST_FILTER" ]; then
            echo "üß™ Running filtered tests: $TEST_FILTER"
            xcodebuild test-without-building \
              -project Food1.xcodeproj \
              -scheme Food1 \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
              -only-testing:"Food1UITests/$TEST_FILTER" \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          else
            echo "üß™ Running all UI tests"
            xcodebuild test-without-building \
              -project Food1.xcodeproj \
              -scheme Food1 \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
              -only-testing:Food1UITests \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          fi

      - name: Capture Screenshots on Failure
        if: failure()
        run: |
          # Capture simulator screenshot
          xcrun simctl io booted screenshot failure-screenshot.png || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            ~/Library/Developer/Xcode/DerivedData/Food1-*/Logs/Test/*.xcresult
            failure-screenshot.png
          if-no-files-found: warn

      - name: Test Summary
        if: always()
        run: |
          echo "üß™ E2E Test run completed!"
          echo ""
          echo "To run locally:"
          echo "  xcodebuild test -scheme Food1 -only-testing:Food1UITests"

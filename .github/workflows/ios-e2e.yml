name: iOS E2E Tests

# Run E2E tests on demand or before releases
# These are slower and test full user flows via XCUITest
#
# REQUIRED SECRETS:
#   SUPABASE_URL         - Your Supabase project URL
#   SUPABASE_ANON_KEY    - Supabase anon/public key
#   SUPABASE_SERVICE_KEY - Supabase service_role key (for creating test users)
#
on:
  workflow_dispatch:
    inputs:
      test_filter:
        description: 'Test filter (e.g., AccountDeletionUITests or leave empty for all)'
        required: false
        default: ''
  # Optionally run on release branches
  push:
    branches:
      - 'release/*'

jobs:
  e2e-tests:
    name: Run E2E Tests
    runs-on: self-hosted

    env:
      DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate Secrets
        run: |
          if [ -z "$SUPABASE_URL" ] || [ -z "$SUPABASE_SERVICE_KEY" ]; then
            echo "‚ùå ERROR: Missing required secrets"
            echo ""
            echo "Please configure these GitHub Secrets:"
            echo "  - SUPABASE_URL: Your Supabase project URL"
            echo "  - SUPABASE_ANON_KEY: Supabase anon/public key"
            echo "  - SUPABASE_SERVICE_KEY: Supabase service_role key"
            echo ""
            echo "Get these from: Supabase Dashboard ‚Üí Settings ‚Üí API"
            exit 1
          fi
          echo "‚úÖ Secrets validated"

      - name: Create Test User
        id: create_user
        run: |
          # Generate unique test email for this run
          TEST_EMAIL="e2e-test-$(date +%s)-$RANDOM@test.prismae.app"
          TEST_PASSWORD="E2ETestPass123!"

          echo "Creating test user: $TEST_EMAIL"

          # Create user via Supabase Admin API (automatically confirmed)
          RESPONSE=$(curl -s -X POST "$SUPABASE_URL/auth/v1/admin/users" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -d "{
              \"email\": \"$TEST_EMAIL\",
              \"password\": \"$TEST_PASSWORD\",
              \"email_confirm\": true
            }")

          # Check for error
          if echo "$RESPONSE" | grep -q '"error"'; then
            echo "‚ùå Failed to create test user"
            echo "$RESPONSE"
            exit 1
          fi

          # Extract user ID
          USER_ID=$(echo "$RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin).get('id', ''))" 2>/dev/null || echo "")

          if [ -z "$USER_ID" ]; then
            echo "‚ùå Could not extract user ID"
            echo "$RESPONSE"
            exit 1
          fi

          echo "‚úÖ Created test user: $USER_ID"

          # Output for later steps
          echo "test_email=$TEST_EMAIL" >> "$GITHUB_OUTPUT"
          echo "test_password=$TEST_PASSWORD" >> "$GITHUB_OUTPUT"
          echo "test_user_id=$USER_ID" >> "$GITHUB_OUTPUT"

      - name: Select Xcode version
        run: |
          xcodebuild -version
          xcrun simctl list devices available | head -20

      - name: Setup API Config for E2E Tests
        run: |
          # Create APIConfig from template
          cp Food1/Config/APIConfig.swift.template Food1/Config/APIConfig.swift 2>/dev/null || true

          # Configure Supabase credentials via Info.plist
          /usr/libexec/PlistBuddy -c "Add :SUPABASE_URL string '$SUPABASE_URL'" Food1/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :SUPABASE_URL '$SUPABASE_URL'" Food1/Info.plist

          /usr/libexec/PlistBuddy -c "Add :SUPABASE_ANON_KEY string '${{ secrets.SUPABASE_ANON_KEY }}'" Food1/Info.plist 2>/dev/null || \
          /usr/libexec/PlistBuddy -c "Set :SUPABASE_ANON_KEY '${{ secrets.SUPABASE_ANON_KEY }}'" Food1/Info.plist

          # Add placeholder for other config
          /usr/libexec/PlistBuddy -c "Add :PROXY_ENDPOINT string 'https://test.example.com'" Food1/Info.plist 2>/dev/null || true
          /usr/libexec/PlistBuddy -c "Add :AUTH_TOKEN string 'test-token'" Food1/Info.plist 2>/dev/null || true

          echo "‚úÖ API config ready"

      - name: Boot Simulator
        run: |
          # Boot iPhone 17 Pro simulator
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 17 Pro" | head -1 | grep -oE '[A-F0-9-]{36}')
          if [ -n "$SIMULATOR_ID" ]; then
            xcrun simctl boot "$SIMULATOR_ID" 2>/dev/null || true
            echo "‚úÖ Booted simulator: $SIMULATOR_ID"
          else
            echo "‚ö†Ô∏è  iPhone 17 Pro not found, trying iPhone 16 Pro..."
            SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 16 Pro" | head -1 | grep -oE '[A-F0-9-]{36}')
            if [ -n "$SIMULATOR_ID" ]; then
              xcrun simctl boot "$SIMULATOR_ID" 2>/dev/null || true
            fi
          fi

      - name: Build for UI Testing
        run: |
          xcodebuild clean build-for-testing \
            -project Food1.xcodeproj \
            -scheme Food1 \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run E2E Tests
        env:
          # Pass as TEST_RUNNER_ prefixed env vars - xcodebuild strips prefix for test runner
          TEST_RUNNER_TEST_USER_EMAIL: ${{ steps.create_user.outputs.test_email }}
          TEST_RUNNER_TEST_USER_PASSWORD: ${{ steps.create_user.outputs.test_password }}
        run: |
          TEST_FILTER="${{ github.event.inputs.test_filter }}"

          echo "üß™ Running E2E tests with user: $TEST_RUNNER_TEST_USER_EMAIL"

          if [ -n "$TEST_FILTER" ]; then
            echo "üìã Filter: $TEST_FILTER"
            xcodebuild test-without-building \
              -project Food1.xcodeproj \
              -scheme Food1 \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
              -only-testing:"Food1UITests/$TEST_FILTER" \
              -parallel-testing-enabled NO \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          else
            echo "üìã Running all UI tests"
            xcodebuild test-without-building \
              -project Food1.xcodeproj \
              -scheme Food1 \
              -configuration Debug \
              -destination 'platform=iOS Simulator,name=iPhone 17 Pro' \
              -only-testing:Food1UITests \
              -parallel-testing-enabled NO \
              CODE_SIGN_IDENTITY="" \
              CODE_SIGNING_REQUIRED=NO \
              CODE_SIGNING_ALLOWED=NO
          fi

      - name: Cleanup Test User
        if: always()
        run: |
          USER_ID="${{ steps.create_user.outputs.test_user_id }}"

          if [ -z "$USER_ID" ]; then
            echo "‚ö†Ô∏è  No user ID to cleanup"
            exit 0
          fi

          echo "üßπ Cleaning up test user: $USER_ID"

          # Delete user via Admin API
          curl -s -X DELETE "$SUPABASE_URL/auth/v1/admin/users/$USER_ID" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "apikey: $SUPABASE_SERVICE_KEY" || true

          echo "‚úÖ Cleanup complete"

      - name: Capture Screenshots on Failure
        if: failure()
        run: |
          xcrun simctl io booted screenshot failure-screenshot.png || true

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            ~/Library/Developer/Xcode/DerivedData/Food1-*/Logs/Test/*.xcresult
            failure-screenshot.png
          if-no-files-found: warn

      - name: Test Summary
        if: always()
        run: |
          echo "üß™ E2E Test run completed!"
          echo ""
          echo "Test user: ${{ steps.create_user.outputs.test_email }}"
          echo ""
          echo "To run locally:"
          echo "  1. Set SUPABASE_URL and SUPABASE_SERVICE_KEY"
          echo "  2. Run: ./scripts/e2e-test-user.sh create"
          echo "  3. Run: xcodebuild test -scheme Food1 -only-testing:Food1UITests"
          echo "  4. Run: ./scripts/e2e-test-user.sh delete"

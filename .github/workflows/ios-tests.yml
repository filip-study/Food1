name: iOS Tests

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'
  workflow_dispatch:
    inputs:
      runner:
        description: 'Runner to use'
        required: true
        default: 'macos-15'
        type: choice
        options:
          - macos-15
          - self-hosted

jobs:
  test:
    name: Run XCTest Suite
    runs-on: ${{ github.event.inputs.runner || 'macos-15' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode.app
          xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices available

      - name: Setup API Config for CI
        run: |
          cp Food1/Config/APIConfig.swift.template Food1/Config/APIConfig.swift
          cat > Food1/Config/Secrets.xcconfig << 'EOF'
          SUPABASE_URL = https://test.supabase.co
          SUPABASE_ANON_KEY = test-anon-key
          PROXY_ENDPOINT = https://test-worker.example.com/analyze
          AUTH_TOKEN = test-auth-token
          EOF
          echo "Config created"

      - name: Build for Testing
        run: |
          xcodebuild clean build-for-testing \
            -project Food1.xcodeproj \
            -scheme Food1 \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

      - name: Run Tests
        run: |
          xcodebuild test-without-building \
            -project Food1.xcodeproj \
            -scheme Food1 \
            -configuration Debug \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -only-testing:Food1Tests \
            -enableCodeCoverage YES \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

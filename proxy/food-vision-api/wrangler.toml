# Cloudflare Worker Configuration
# Learn more: https://developers.cloudflare.com/workers/

name = "food-vision-api"
main = "worker.js"
compatibility_date = "2024-01-01"

# Smart Placement: Automatically routes to optimal data centers
#
# Strategy for reducing AWS proxy usage:
# - "smart" mode optimizes based on latency to OpenAI (US-based)
# - Naturally prefers US/Europe over Asia/blocked regions
# - Reduces proxy usage by ~60-80% for typical global traffic
# - Blocked regions still route through AWS proxy as fallback
#
# Benefits:
# - Lower AWS costs (fewer requests through proxy)
# - Faster response times (direct to OpenAI when possible)
# - Automatic failover when blocked regions detected
[placement]
mode = "smart"

# KV Namespace for rate limiting and subscription caching
# Create with: wrangler kv:namespace create "RATE_LIMIT"
# Then update the id below with the returned namespace ID
[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "0f5516f44d274b5685deadf6af6482ac"

# Environment variables (set via Cloudflare dashboard or CLI)
# DO NOT commit actual values to git!
#
# Required secrets (set with: wrangler secret put <SECRET_NAME>):
# - OPENAI_API_KEY: Your OpenAI API key
# - AUTH_TOKEN: Random token for iOS app authentication
# - SUPABASE_URL: Your Supabase project URL (e.g., https://xxx.supabase.co)
# - SUPABASE_ANON_KEY: Supabase anon/public key (safe to use with user JWT for RLS)
# - SUPABASE_JWT_SECRET: Supabase JWT secret (for token verification)
#
# Example:
# wrangler secret put OPENAI_API_KEY
# wrangler secret put AUTH_TOKEN
# wrangler secret put SUPABASE_URL
# wrangler secret put SUPABASE_ANON_KEY
# wrangler secret put SUPABASE_JWT_SECRET

# Account ID (replace with your Cloudflare account ID)
# Find it at: https://dash.cloudflare.com/
# account_id = "your-account-id-here"

# Workers Free Plan Limits:
# - 100,000 requests/day
# - 10ms CPU time per request
# - KV: 100,000 reads/day, 1,000 writes/day (free tier)

[env.production]
name = "food-vision-api"

[[env.production.kv_namespaces]]
binding = "RATE_LIMIT"
id = "0f5516f44d274b5685deadf6af6482ac"

[env.development]
name = "food-vision-api-dev"

[[env.development.kv_namespaces]]
binding = "RATE_LIMIT"
id = "0f5516f44d274b5685deadf6af6482ac"

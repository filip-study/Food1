# Nginx Reverse Proxy Configuration for OpenAI API
# This proxies requests from Cloudflare Worker to OpenAI API
#
# Location: /etc/nginx/sites-available/openai-proxy
# Enable: sudo ln -s /etc/nginx/sites-available/openai-proxy /etc/nginx/sites-enabled/
# Test: sudo nginx -t
# Reload: sudo systemctl reload nginx

# Upstream OpenAI API
upstream openai {
    server api.openai.com:443;
    keepalive 10;
}

server {
    listen 8888;
    server_name _;

    # Security: Only allow POST requests
    if ($request_method !~ ^(POST|OPTIONS)$) {
        return 405;
    }

    # CORS headers for OPTIONS preflight
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-OpenAI-API-Key';
        add_header Access-Control-Max-Age 86400;
        return 204;
    }

    # Basic Authentication
    # Create password file: sudo htpasswd -c /etc/nginx/.htpasswd username
    auth_basic "OpenAI Proxy";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Proxy OpenAI API requests
    location /v1/ {
        # Resolve DNS dynamically (important for upstream SSL)
        resolver 8.8.8.8 8.8.4.4 valid=300s;
        resolver_timeout 5s;

        # Proxy to OpenAI
        proxy_pass https://api.openai.com$request_uri;
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;

        # Convert X-OpenAI-API-Key to Authorization header
        proxy_set_header Authorization "Bearer $http_x_openai_api_key";
        proxy_set_header Content-Type "application/json";
        proxy_set_header Host "api.openai.com";
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Remove the custom header before forwarding
        proxy_set_header X-OpenAI-API-Key "";

        # Timeouts for long-running GPT-4o requests
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # Buffering
        proxy_buffering on;
        proxy_buffer_size 4k;
        proxy_buffers 8 4k;

        # CORS headers for actual requests
        add_header Access-Control-Allow-Origin * always;
        add_header Access-Control-Allow-Methods 'POST, OPTIONS' always;
        add_header Access-Control-Allow-Headers 'Content-Type, Authorization, X-OpenAI-API-Key' always;
    }

    # Health check endpoint (no auth required)
    location /health {
        auth_basic off;
        return 200 "OK\n";
        add_header Content-Type text/plain;
    }

    # Block all other requests
    location / {
        return 404;
    }

    # Logging
    access_log /var/log/nginx/openai-proxy-access.log;
    error_log /var/log/nginx/openai-proxy-error.log;
}
